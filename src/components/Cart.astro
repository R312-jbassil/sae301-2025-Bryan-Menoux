---

---

<div
  id="cart-modal"
  class="fixed bottom-6 right-6 hidden z-1000 opacity-0 translate-y-4 transition-all duration-300"
>
  <div
    class="bg-white rounded-lg w-[500px] max-h-[80vh] overflow-hidden shadow-xl border border-gray-200 flex flex-col"
  >
    <!-- Header -->
    <div class="px-6 py-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900 m-0">Panier</h3>
        <button
          id="close-cart-btn"
          class="bg-none border-none cursor-pointer p-0 flex items-center justify-center w-8 h-8"
        >
          <svg
            class="w-6 h-6 text-gray-400 hover:text-gray-600 transition-colors"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Cart Items -->
    <div
      id="cart-items-container"
      class="flex-1 overflow-y-auto px-6 py-4 space-y-4"
    >
      <!-- Items will be added here dynamically -->
      <div
        id="empty-cart-message"
        class="text-center py-8 text-gray-500 text-sm"
      >
        Votre panier est vide
      </div>
    </div>

    <!-- Total and Buttons -->
    <div class="px-6 py-4 border-t border-gray-200 space-y-4">
      <div class="flex justify-between items-center">
        <span class="text-gray-600 font-medium">Total:</span>
        <span id="cart-total" class="text-lg font-bold text-gray-900">0 ‚Ç¨</span>
      </div>

      <button
        id="proceed-to-checkout-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        Proc√©der au paiement
      </button>

      <button
        id="continue-shopping-btn"
        class="w-full text-blue-600 hover:text-blue-700 font-medium py-2 px-4 text-sm transition-colors duration-200"
      >
        Continuer vos achats
      </button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div
  id="payment-modal"
  class="fixed inset-0 hidden z-1001 items-center justify-center bg-black/50"
>
  <div class="bg-white rounded-lg w-[90%] max-w-[500px] shadow-2xl">
    <!-- Header -->
    <div class="px-6 py-6 border-b border-gray-200">
      <h3 class="text-xl font-semibold text-gray-900 m-0">Paiement</h3>
    </div>

    <!-- Body -->
    <div class="px-6 py-6 space-y-4">
      <!-- Error Message -->
      <div
        id="payment-error-message"
        class="hidden p-4 bg-red-50 border border-red-200 rounded-lg"
      >
        <div class="flex gap-3">
          <div class="shrink-0 text-red-600">‚úï</div>
          <p
            id="payment-error-text"
            class="text-sm font-medium text-red-900 m-0"
          >
          </p>
        </div>
      </div>

      <!-- Success Message -->
      <div
        id="payment-success-message"
        class="hidden p-4 bg-green-50 border border-green-200 rounded-lg"
      >
        <div class="flex gap-3">
          <div class="shrink-0 text-green-600">‚úì</div>
          <div>
            <p class="text-sm font-medium text-green-900 m-0">
              Paiement effectu√© avec succ√®s !
            </p>
            <p
              id="payment-success-text"
              class="text-xs text-green-700 mt-1 m-0"
            >
            </p>
          </div>
        </div>
      </div>

      <!-- Payment Form -->
      <div id="payment-form" class="space-y-4">
        <div>
          <label
            for="card-number"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Num√©ro de carte
          </label>
          <input
            id="card-number"
            type="text"
            placeholder="4111 1111 1111 1111"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            maxlength="19"
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              for="card-expiry"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Expiration
            </label>
            <input
              id="card-expiry"
              type="text"
              placeholder="MM/YY"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              maxlength="5"
            />
          </div>
          <div>
            <label
              for="card-cvc"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              CVC
            </label>
            <input
              id="card-cvc"
              type="text"
              placeholder="123"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              maxlength="4"
            />
          </div>
        </div>

        <div>
          <label
            for="card-name"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Nom du titulaire
          </label>
          <input
            id="card-name"
            type="text"
            placeholder="Jean Dupont"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-xs text-blue-800 m-0">
            üí≥ Mode de d√©monstration : Utilisez n'importe quelle carte pour
            tester le paiement fictif.
          </p>
        </div>

        <div class="flex justify-between items-center pt-2">
          <span class="text-gray-600 font-medium">Total √† payer:</span>
          <span id="payment-total" class="text-lg font-bold text-gray-900"
            >0 ‚Ç¨</span
          >
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="px-6 py-4 border-t border-gray-200 flex gap-3 justify-end">
      <button
        id="cancel-payment-btn"
        class="px-4 py-2 border border-gray-300 rounded font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200 cursor-pointer"
      >
        Annuler
      </button>
      <button
        id="confirm-payment-btn"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors duration-200 cursor-pointer"
      >
        Payer maintenant
      </button>
    </div>
  </div>
</div>

<script is:inline>
  // Cart state
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");

  // DOM elements
  const cartModal = document.getElementById("cart-modal");
  const cartItemsContainer = document.getElementById("cart-items-container");
  const emptyCartMessage = document.getElementById("empty-cart-message");
  const cartTotal = document.getElementById("cart-total");
  const closeCartBtn = document.getElementById("close-cart-btn");
  const proceedToCheckoutBtn = document.getElementById(
    "proceed-to-checkout-btn"
  );
  const continueShoppingBtn = document.getElementById("continue-shopping-btn");

  // Payment modal
  const paymentModal = document.getElementById("payment-modal");
  const paymentForm = document.getElementById("payment-form");
  const paymentErrorMessage = document.getElementById("payment-error-message");
  const paymentErrorText = document.getElementById("payment-error-text");
  const paymentSuccessMessage = document.getElementById(
    "payment-success-message"
  );
  const paymentSuccessText = document.getElementById("payment-success-text");
  const paymentTotal = document.getElementById("payment-total");
  const cancelPaymentBtn = document.getElementById("cancel-payment-btn");
  const confirmPaymentBtn = document.getElementById("confirm-payment-btn");

  // Payment input fields
  const cardNumber = document.getElementById("card-number");
  const cardExpiry = document.getElementById("card-expiry");
  const cardCvc = document.getElementById("card-cvc");
  const cardName = document.getElementById("card-name");

  // Global function to open cart
  window.openCart = function () {
    if (cartModal) {
      cartModal.classList.remove("hidden");
      cartModal.offsetHeight;
      cartModal.classList.remove("opacity-0", "translate-y-4");
      cartModal.classList.add("opacity-100", "translate-y-0");
    }
  };

  // Close cart
  function closeCart() {
    if (cartModal) {
      cartModal.classList.add("opacity-0", "translate-y-4");
      cartModal.classList.remove("opacity-100", "translate-y-0");
      setTimeout(() => {
        cartModal.classList.add("hidden");
      }, 300);
    }
  }

  // Add item to cart
  window.addToCart = function (modeleId, title, price) {
    const existingItem = cart.find((item) => item.id === modeleId);

    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cart.push({
        id: modeleId,
        title: title,
        price: price,
        quantity: 1,
      });
    }

    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartUI();
    openCart();

    // Show notification
    showNotification("Ajout√© au panier!");
  };

  // Remove item from cart
  function removeFromCart(modeleId) {
    cart = cart.filter((item) => item.id !== modeleId);
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartUI();
  }

  // Update quantity
  function updateQuantity(modeleId, quantity) {
    const item = cart.find((item) => item.id === modeleId);
    if (item) {
      if (quantity <= 0) {
        removeFromCart(modeleId);
      } else {
        item.quantity = quantity;
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartUI();
      }
    }
  }

  // Update cart UI
  function updateCartUI() {
    cartItemsContainer.innerHTML = "";

    if (cart.length === 0) {
      emptyCartMessage.classList.remove("hidden");
      proceedToCheckoutBtn.disabled = true;
    } else {
      emptyCartMessage.classList.add("hidden");
      proceedToCheckoutBtn.disabled = false;

      cart.forEach((item) => {
        const itemTotal = item.price * item.quantity;
        const itemEl = document.createElement("div");
        itemEl.className =
          "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
        itemEl.innerHTML = `
          <div class="flex-1">
            <p class="font-medium text-gray-900 text-sm m-0">${item.title}</p>
            <p class="text-xs text-gray-600 m-0">${item.price.toFixed(2)} ‚Ç¨ x ${item.quantity}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-semibold text-gray-900 text-sm">${itemTotal.toFixed(2)} ‚Ç¨</span>
            <button
              class="text-red-500 hover:text-red-700 text-sm font-medium"
              onclick="window.removeFromCart('${item.id}')"
            >
              √ó
            </button>
          </div>
        `;
        cartItemsContainer.appendChild(itemEl);
      });
    }

    // Update total
    const total = cart.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    );
    cartTotal.textContent = total.toFixed(2) + " ‚Ç¨";
    paymentTotal.textContent = total.toFixed(2) + " ‚Ç¨";
  }

  // Close cart button
  closeCartBtn?.addEventListener("click", closeCart);
  continueShoppingBtn?.addEventListener("click", closeCart);

  // Proceed to checkout
  proceedToCheckoutBtn?.addEventListener("click", () => {
    paymentForm.classList.remove("hidden");
    paymentErrorMessage.classList.add("hidden");
    paymentSuccessMessage.classList.add("hidden");
    cardNumber.value = "";
    cardExpiry.value = "";
    cardCvc.value = "";
    cardName.value = "";

    paymentModal.classList.remove("hidden");
    paymentModal.style.display = "flex";
  });

  // Cancel payment
  cancelPaymentBtn?.addEventListener("click", () => {
    paymentModal.classList.add("hidden");
    paymentModal.style.display = "none";
  });

  // Format card number with spaces
  cardNumber?.addEventListener("input", (e) => {
    let value = e.target.value.replace(/\s/g, "");
    let formatted = value.match(/.{1,4}/g)?.join(" ") || value;
    e.target.value = formatted;
  });

  // Format expiry (MM/YY)
  cardExpiry?.addEventListener("input", (e) => {
    let value = e.target.value.replace(/\D/g, "");
    if (value.length >= 2) {
      value = value.slice(0, 2) + "/" + value.slice(2, 4);
    }
    e.target.value = value;
  });

  // Only allow digits in CVC
  cardCvc?.addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/\D/g, "");
  });

  // Confirm payment
  confirmPaymentBtn?.addEventListener("click", async () => {
    // Validate card fields
    if (
      !cardNumber.value ||
      cardNumber.value.replace(/\s/g, "").length !== 16
    ) {
      paymentErrorText.textContent = "Num√©ro de carte invalide";
      paymentErrorMessage.classList.remove("hidden");
      return;
    }

    if (!cardExpiry.value || !cardExpiry.value.includes("/")) {
      paymentErrorText.textContent = "Date d'expiration invalide (MM/YY)";
      paymentErrorMessage.classList.remove("hidden");
      return;
    }

    if (!cardCvc.value || cardCvc.value.length < 3) {
      paymentErrorText.textContent = "CVC invalide";
      paymentErrorMessage.classList.remove("hidden");
      return;
    }

    if (!cardName.value.trim()) {
      paymentErrorText.textContent = "Veuillez entrer le nom du titulaire";
      paymentErrorMessage.classList.remove("hidden");
      return;
    }

    try {
      paymentForm.classList.add("hidden");
      confirmPaymentBtn.disabled = true;
      confirmPaymentBtn.textContent = "Traitement...";

      // Get user ID from localStorage
      const id_utilisateur = localStorage.getItem("id_utilisateur");
      if (!id_utilisateur) {
        throw new Error("Vous devez √™tre connect√© pour passer commande");
      }

      // Calculate total
      const total = cart.reduce(
        (sum, item) => sum + item.price * item.quantity,
        0
      );

      // Create order in commande collection
      const orderResponse = await fetch(
        "http://127.0.0.1:8090/api/collections/commande/records",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id_utilisateur: id_utilisateur,
            total: total,
            statut: "confirm√©e",
          }),
        }
      );

      if (!orderResponse.ok) {
        const errorText = await orderResponse.text();
        console.error("Erreur cr√©ation commande:", errorText);
        throw new Error("Erreur lors de la cr√©ation de la commande");
      }

      const orderData = await orderResponse.json();
      const commandeId = orderData.id;

      // Create line items in ligne_commande collection
      for (const item of cart) {
        const lineResponse = await fetch(
          "http://127.0.0.1:8090/api/collections/ligne_commande/records",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id_commande: commandeId,
              id_modele: item.id,
              quantite: item.quantity,
            }),
          }
        );

        if (!lineResponse.ok) {
          const errorText = await lineResponse.text();
          console.error("Erreur cr√©ation ligne commande:", errorText);
          throw new Error("Erreur lors de la cr√©ation des lignes de commande");
        }
      }

      // Success!
      paymentSuccessText.textContent = `Commande #${commandeId} cr√©√©e avec succ√®s !`;
      paymentSuccessMessage.classList.remove("hidden");
      confirmPaymentBtn.disabled = false;
      confirmPaymentBtn.textContent = "Payer maintenant";

      // Clear cart after 2 seconds
      setTimeout(() => {
        cart = [];
        localStorage.removeItem("cart");
        updateCartUI();
        paymentModal.classList.add("hidden");
        paymentModal.style.display = "none";
        closeCart();
        showNotification("Commande cr√©√©e avec succ√®s !");
      }, 2000);
    } catch (error) {
      console.error("Erreur paiement:", error);
      paymentForm.classList.remove("hidden");
      paymentErrorText.textContent = error.message || "Erreur lors du paiement";
      paymentErrorMessage.classList.remove("hidden");
      confirmPaymentBtn.disabled = false;
      confirmPaymentBtn.textContent = "Payer maintenant";
    }
  });

  // Helper function to show notification
  function showNotification(message) {
    const notification = document.createElement("div");
    notification.className =
      "fixed top-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg animate-in fade-in duration-200 z-1002";
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Make removeFromCart available globally
  window.removeFromCart = removeFromCart;

  // Initialize UI on load
  updateCartUI();
</script>
