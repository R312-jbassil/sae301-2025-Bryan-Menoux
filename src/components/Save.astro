---
import pb from "../lib/pocketbase.js";
---

<div
  id="save-modal"
  class="fixed bottom-6 right-6 hidden z-1000 opacity-0 translate-y-4 transition-all duration-300"
>
  <div class="bg-white rounded-lg w-[400px] shadow-xl border border-gray-200">
    <div class="px-6 py-6 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 m-0">
        Enregistrer votre configuration
      </h3>
    </div>

    <div class="px-6 py-6">
      <!-- Message d'erreur -->
      <div
        id="save-error-message"
        class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg animate-in fade-in duration-200"
      >
        <div class="flex gap-3">
          <div class="shrink-0 text-red-600 text-xl leading-none">✕</div>
          <div>
            <p id="save-error-text" class="text-sm font-medium text-red-900">
            </p>
          </div>
        </div>
      </div>

      <!-- Message de succès -->
      <div
        id="save-success-message"
        class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg animate-in fade-in duration-200"
      >
        <div class="flex gap-3">
          <div class="shrink-0 text-green-600 text-xl leading-none">✓</div>
          <div>
            <p
              id="save-success-text"
              class="text-sm font-medium text-green-900"
            >
            </p>
          </div>
        </div>
      </div>

      <!-- Formulaire de saisie -->
      <div id="save-form" class="space-y-3">
        <label for="save-title" class="block text-sm font-medium text-gray-700">
          Titre de votre paire de lunettes
        </label>
        <input
          id="save-title"
          type="text"
          placeholder="Ex: Lunettes de soleil été"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        />
        <p class="text-xs text-gray-500">
          Ce titre vous permettra de retrouver facilement votre configuration
        </p>
      </div>
    </div>

    <div class="px-6 py-4 border-t border-gray-200 flex gap-3 justify-end">
      <button
        id="cancel-save-btn"
        class="px-4 py-2 border border-gray-300 rounded font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200 cursor-pointer"
      >
        Annuler
      </button>
      <button
        id="confirm-save-btn"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors duration-200 cursor-pointer"
      >
        Enregistrer
      </button>
    </div>
  </div>
</div>

<script is:inline>
  // Éléments du modal
  const saveModal = document.getElementById("save-modal");
  const saveTitleInput = document.getElementById("save-title");
  const cancelSaveBtn = document.getElementById("cancel-save-btn");
  const confirmSaveBtn = document.getElementById("confirm-save-btn");
  const saveForm = document.getElementById("save-form");
  const saveErrorMessage = document.getElementById("save-error-message");
  const saveErrorText = document.getElementById("save-error-text");
  const saveSuccessMessage = document.getElementById("save-success-message");
  const saveSuccessText = document.getElementById("save-success-text");

  // Fonction pour ouvrir le modal de sauvegarde
  window.openSaveModal = function () {
    if (saveModal) {
      // Réinitialiser l'input
      saveTitleInput.value = "";

      // Réinitialiser les messages
      saveErrorMessage.classList.add("hidden");
      saveSuccessMessage.classList.add("hidden");
      saveForm.classList.remove("hidden");

      // Réinitialiser les boutons
      cancelSaveBtn.textContent = "Annuler";
      confirmSaveBtn.classList.remove("hidden");

      // Afficher le modal
      saveModal.classList.remove("hidden");
      // Forcer un reflow pour que la transition fonctionne
      saveModal.offsetHeight;
      saveModal.classList.remove("opacity-0", "translate-y-4");
      saveModal.classList.add("opacity-100", "translate-y-0");

      // Focus sur l'input pour une meilleure UX
      setTimeout(() => {
        saveTitleInput.focus();
      }, 50);
    }
  };

  // Fonction pour fermer le modal de sauvegarde
  function closeSaveModal() {
    if (saveModal) {
      saveModal.classList.add("opacity-0", "translate-y-4");
      saveModal.classList.remove("opacity-100", "translate-y-0");
      setTimeout(() => {
        saveModal.classList.add("hidden");
      }, 300);
    }
  }

  // Fonction pour afficher une erreur
  function showError(message) {
    saveErrorText.textContent = message;
    saveErrorMessage.classList.remove("hidden");
    saveForm.classList.add("hidden");
    saveSuccessMessage.classList.add("hidden");
    // Réinitialiser les boutons
    cancelSaveBtn.textContent = "Annuler";
    confirmSaveBtn.classList.remove("hidden");
  }

  // Fonction pour afficher un succès
  function showSuccess(message) {
    saveSuccessText.textContent = message;
    saveSuccessMessage.classList.remove("hidden");
    saveForm.classList.add("hidden");
    saveErrorMessage.classList.add("hidden");
    cancelSaveBtn.textContent = "Fermer";
    confirmSaveBtn.classList.add("hidden");
  }

  // Fermer quand on clique sur Annuler
  cancelSaveBtn?.addEventListener("click", () => {
    closeSaveModal();
  });

  // Enregistrer quand on clique sur Enregistrer
  confirmSaveBtn?.addEventListener("click", async () => {
    const titre = saveTitleInput.value.trim();

    if (!titre) {
      showError("Veuillez entrer un titre pour votre paire de lunettes");
      saveTitleInput.focus();
      return;
    }

    try {
      // Déterminer l'URL de base
      const baseUrl =
        window.location.hostname === "localhost"
          ? "http://localhost:8090"
          : "https://ta-vue.bryan-menoux.fr";

      // Récupérer la configuration actuelle depuis localStorage
      const couleursLunettes = JSON.parse(
        localStorage.getItem("couleursLunettes") || "{}"
      );
      const materiaux = JSON.parse(localStorage.getItem("materiaux") || "{}");
      const optionsVerres = JSON.parse(
        localStorage.getItem("optionsVerres") || "{}"
      );
      const tailles = JSON.parse(localStorage.getItem("tailles") || "{}");
      const finitions = JSON.parse(localStorage.getItem("finitions") || "{}");

      // Générer le code SVG complet avec les bonnes couleurs
      const svgCode = generateSVGWithColors(couleursLunettes, optionsVerres);

      // Récupérer les IDs des matériaux en fonction de leurs noms
      let id_materiau_monture = "";
      let id_materiau_branches = "";

      // Map pour convertir les valeurs du select aux noms complets dans PocketBase
      const materiauNamesMap = {
        acetate: "Acétate de cellulose",
        titane: "Titane",
        inox: "Inox",
      };

      console.log("Matériaux récupérés:", materiaux);

      // Fonction pour chercher un matériau
      async function findMateriau(libelle) {
        try {
          // Essayer d'abord avec le filtre exact
          let response = await fetch(
            `${baseUrl}/api/collections/materiau/records?filter=(libelle_materiau="${libelle}")`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            console.log(`Résultat pour "${libelle}":`, data);
            if (data.items && data.items.length > 0) {
              return data.items[0].id;
            }
          }

          // Si pas de résultat, essayer un filtre contenant
          const searchTerm = libelle.split(" ")[0]; // Prendre le premier mot
          response = await fetch(
            `${baseUrl}/api/collections/materiau/records?filter=(libelle_materiau~"${searchTerm}")`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            console.log(
              `Résultat recherche partielle pour "${searchTerm}":`,
              data
            );
            if (data.items && data.items.length > 0) {
              return data.items[0].id;
            }
          }

          return "";
        } catch (error) {
          console.error(`Erreur lors de la recherche de ${libelle}:`, error);
          return "";
        }
      }

      // Chercher le matériau de monture
      if (materiaux.monture) {
        const montureLibelle =
          materiauNamesMap[materiaux.monture] || materiaux.monture;
        console.log("Recherche monture:", montureLibelle);
        id_materiau_monture = await findMateriau(montureLibelle);
      } else {
        console.warn("Aucun matériau monture sélectionné");
      }

      // Chercher le matériau de branches
      if (materiaux.branches) {
        const branchesLibelle =
          materiauNamesMap[materiaux.branches] || materiaux.branches;
        console.log("Recherche branches:", branchesLibelle);
        id_materiau_branches = await findMateriau(branchesLibelle);
      } else {
        console.warn("Aucun matériau branches sélectionné");
      }

      console.log(
        "IDs trouvés - Monture:",
        id_materiau_monture,
        "Branches:",
        id_materiau_branches
      );

      // Vérifier que l'utilisateur est connecté
      const id_utilisateur = localStorage.getItem("id_utilisateur");
      if (!id_utilisateur) {
        showError(
          "Vous devez être connecté pour enregistrer une configuration"
        );
        return;
      }

      // Créer l'objet de données pour PocketBase
      const modelData = {
        titre: titre,
        code_svg: svgCode,
        couleur_monture: couleursLunettes.monture || "#4169E1",
        couleur_branches: couleursLunettes.branches || "black",
        finition: finitions.finition || "",
        largeur_verres: tailles.largeurVerres || 0,
        hauteur_verres: tailles.hauteurVerres || 0,
        largeur_pont: tailles.largeurPont || 0,
        verres_teintes: optionsVerres.verresTeintes || false,
        teinte_hex: optionsVerres.teinte || "",
        verres_polarises: optionsVerres.verresPolarises || false,
        prix: 203,
        // Champs obligatoires
        id_materiau_monture: id_materiau_monture,
        id_materiau_branches: id_materiau_branches,
        id_utilisateur: id_utilisateur,
      };

      console.log("Tailles récupérées:", tailles);
      console.log("Données envoyées à PocketBase:", modelData);

      // Vérifier que les matériaux ont été trouvés
      if (!id_materiau_monture || !id_materiau_branches) {
        showError(
          "Les matériaux sélectionnés n'ont pas pu être trouvés. Veuillez vérifier votre sélection."
        );
        return;
      }

      // Envoyer les données à PocketBase
      const response = await fetch(
        `${baseUrl}/api/collections/modele/records`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(modelData),
        }
      );

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Réponse d'erreur PocketBase:", errorText);
        let errorMessage = "Erreur lors de l'enregistrement";
        try {
          const errorData = JSON.parse(errorText);
          errorMessage = errorData.details || errorData.error || errorMessage;
        } catch (e) {
          errorMessage = errorText || errorMessage;
        }
        throw new Error(errorMessage);
      }

      const result = await response.json();
      console.log("Modèle créé avec succès - ID:", result.id);

      // Sauvegarder aussi dans localStorage pour la synchronisation locale
      const configuration = {
        titre: titre,
        timestamp: new Date().toISOString(),
        id_pocketbase: result.id,
        couleursLunettes,
        materiaux,
        optionsVerres,
        tailles,
        finitions,
      };

      let configurationsEnregistrees = JSON.parse(
        localStorage.getItem("configurationsEnregistrees") || "[]"
      );
      configurationsEnregistrees.push(configuration);
      localStorage.setItem(
        "configurationsEnregistrees",
        JSON.stringify(configurationsEnregistrees)
      );

      console.log(
        "Configuration sauvegardée - Configurations totales:",
        configurationsEnregistrees.length
      );

      // Afficher le message de succès dans le popup
      showSuccess("Configuration enregistrée avec succès : " + titre);

      // Émettre un événement pour notifier d'autres composants si nécessaire
      window.dispatchEvent(
        new CustomEvent("configurationSaved", {
          detail: { configuration, result },
        })
      );
    } catch (error) {
      console.error("Erreur lors de l'enregistrement:", error);
      showError(
        error.message || "Erreur lors de l'enregistrement de la configuration"
      );
    }
  });

  // Fonction pour générer le SVG avec les couleurs appliquées
  function generateSVGWithColors(couleursLunettes, optionsVerres) {
    const couleurMonture = couleursLunettes.monture || "#4169E1";
    const couleurBranches = couleursLunettes.branches || "black";

    // Déterminer le gradient ou la couleur des verres
    let verresFill = "#D2E5FF";
    if (optionsVerres.verresTeintes && optionsVerres.teinte) {
      const colorToGradientMap = {
        "#FF1493": "url(#gradient-magenta-rose)",
        "#FFD7BE": "url(#gradient-beige-orange)",
        "#00CED1": "url(#gradient-cyan-vert)",
        "#F5DEB3": "url(#gradient-beige-tan)",
        "#40E0D0": "url(#gradient-turquoise-vert)",
        "#FFFF00": "url(#gradient-citron-vert)",
        "#FF6347": "url(#gradient-tomate-cramoisi)",
      };
      verresFill = colorToGradientMap[optionsVerres.teinte] || "#D2E5FF";
    }

    const svg = `<svg
  width="564"
  height="217"
  viewBox="0 0 564 217"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <g clip-path="url(#clip0_97_378)">
    <path
      id="branches"
      d="M8.11946 60.0087C8.11946 60.0087 76.8439 52.2607 84.6146 47.8234C92.3852 43.386 100.128 36.7508 111.77 34.5391C123.412 32.3273 201.565 19.043 201.565 19.043C201.565 19.043 211.535 16.2749 225.949 26.791C240.362 37.3072 271.96 71.0813 280.817 69.9824C289.688 68.8696 294.116 56.6981 291.345 51.1618C288.574 45.6255 234.708 5.60573 225.392 2.9906C212.12 -0.737352 194.908 -0.333954 173.838 2.9906C152.782 6.31515 11.9909 35.4571 11.9909 35.4571C11.9909 35.4571 -6.29388 43.9702 8.10553 60.0226L8.11946 60.0087Z"
      fill="${couleurBranches}"
      stroke="#1D1D1B"
      stroke-width="0.5"
      stroke-miterlimit="10"></path>
    <g style="mix-blend-mode:multiply">
      <path
        d="M285.816 53.9161C285.816 53.9161 285.384 62.4709 280.274 61.6641C273.352 60.5791 230.391 14.6057 215.978 16.8174C215.978 16.8174 227.856 20.5871 241.685 33.009C250.751 41.1604 289.618 85.6593 285.816 53.9161Z"
        fill="#706F6F"></path>
    </g>
    <path
      id="branches"
      d="M378.493 94.1027L504.579 52.678C504.579 52.678 535.397 44.8465 539.881 47.0861C544.365 49.3256 564.544 89.6236 564.544 94.1027C564.544 98.5818 561.174 113.591 556.703 114.815C553.459 115.705 549.281 114.968 547.178 108.959C545.215 103.367 537.653 64.8216 529.812 65.1833C521.972 65.545 459.208 87.3702 459.208 87.3702C459.208 87.3702 440.714 96.3284 432.874 103.047C425.034 109.766 388.047 118.724 388.047 118.724C388.047 118.724 374.594 108.083 378.521 94.0888L378.493 94.1027Z"
      fill="${couleurBranches}"
      stroke="#1D1D1B"
      stroke-width="0.5"
      stroke-miterlimit="10"></path>
    <g style="mix-blend-mode:multiply">
      <path
        d="M387.615 94.7287C387.615 94.7287 530.036 45.7785 537.806 50.2298C537.806 50.2298 512.461 53.6934 479.652 66.7552C446.842 79.8169 387.615 97.3995 387.615 97.3995V94.7287Z"
        fill="#706F6F"></path>
    </g>
    <g style="mix-blend-mode:multiply">
      <path
        d="M532.473 64.0705C532.473 64.0705 537.013 64.0705 539.408 68.8696C541.803 73.6686 553.013 103.242 553.013 103.242C553.013 103.242 554.086 110.169 560.213 99.5139C560.213 99.5139 555.938 112.812 552.749 108.959C549.56 105.106 539.143 72.3332 539.143 72.3332C539.143 72.3332 535.146 62.9577 532.473 64.0705Z"
        fill="#706F6F"></path>
    </g>
    <path
      id="verres"
      d="M261.945 202.703L296.945 208.203H320.444L341.944 200.703L352.944 184.703L358.444 160.203C359.278 155.203 360.844 144.903 360.444 143.703C359.944 142.203 358.944 126.203 358.444 124.203C357.944 122.203 356.444 104.703 354.944 101.203C353.444 97.7026 336.444 91.2026 334.444 91.2026C332.444 91.2026 297.944 83.7026 295.444 82.7026C293.444 81.9026 270.944 81.036 259.944 80.7026C247.611 81.2026 222.444 82.3026 220.444 82.7026C217.944 83.2026 204.445 94.7026 202.945 96.7026C201.445 98.7026 199.445 108.203 199.945 109.703C200.445 111.203 214.445 144.203 214.945 147.703C215.345 150.503 224.111 170.203 228.445 179.703L261.945 202.703Z"
      fill="${verresFill}"
      fill-opacity="0.73"></path>
    <path
      id="verres"
      d="M86.9444 173.703L116.444 175.703L125.944 169.703L135.444 154.703C138.111 150.203 143.444 140.903 143.444 139.703C143.444 138.203 146.944 120.203 148.444 118.203C149.944 116.203 151.944 96.7026 151.444 92.7026C150.944 88.7026 144.944 80.7026 143.444 78.2026C141.944 75.7026 125.444 66.7026 119.944 63.2026C114.444 59.7026 97.9443 54.7026 92.9443 52.7026C87.9443 50.7026 63.9443 44.2026 60.4443 43.7026C56.9443 43.2026 32.9443 40.2026 31.4443 41.2026C29.9443 42.2026 20.4444 46.2026 20.4444 49.2026V68.2027C20.4444 71.7027 19.4444 91.2026 20.4444 96.7026C21.4444 102.203 24.9444 117.703 25.9444 120.203C26.9444 122.703 38.9444 147.703 40.9444 149.203C42.9444 150.703 53.4444 165.203 55.4444 166.703C57.0444 167.903 77.1111 171.869 86.9444 173.703Z"
      fill="${verresFill}"
      fill-opacity="0.73"></path>
    <path
      id="monture"
      d="M393.143 95.7162C392.809 90.9728 379.816 88.4551 375.443 86.8137C371.07 85.1723 353.579 89.5401 353.579 89.5401C336.632 85.1723 277.614 76.9791 243.732 76.9791C209.85 76.9791 198.375 92.809 194.545 92.2665C190.716 91.724 170.495 91.1815 161.75 89.5401C153.004 87.8987 154.648 69.8849 107.091 52.7057C59.5475 35.5266 11.9904 35.4292 11.9904 35.4292C-6.60067 41.9114 2.57651 61.1493 2.57651 61.1493L5.43133 69.9823C11.4473 72.8061 9.80407 84.6159 11.9904 102.087C14.1768 119.558 22.3792 141.94 31.6678 155.586C40.9564 169.232 75.9383 184.519 93.4292 185.062C110.92 185.604 126.225 182.335 137.7 163.765C149.175 145.209 161.207 112.45 161.207 112.45L175.411 114.634C175.411 114.634 179.464 115.065 182.862 118.932C186.259 122.8 189.031 130.102 193.445 143.011C203.973 173.753 228.427 197.609 228.427 197.609C228.427 197.609 236.226 207.944 274.995 215.219C307.137 221.256 334.459 211.797 334.459 211.797C359.136 201.824 364.581 149.257 364.581 149.257C364.581 149.257 367.129 130.756 375.457 126.096C385.72 120.337 386.974 119.92 393.157 118.696C398.184 117.708 393.491 100.432 393.157 95.6884L393.143 95.7162ZM121.852 165.977C108.734 173.071 77.0384 175.798 57.3611 160.524C37.6838 145.237 28.3952 118.487 25.6657 86.8276C22.9362 55.1678 35.5531 51.732 35.5531 51.732C35.5531 51.732 56.2749 50.8 83.0544 57.3379C109.834 63.8896 139.343 82.4459 139.9 94.4643C140.443 106.469 134.984 158.883 121.866 165.977H121.852ZM336.632 199.821C324.057 205.83 306.733 206.372 292.166 205.273C277.6 204.188 239.888 203.09 226.227 161.595C226.227 161.595 222.397 141.94 219.125 137.572C215.852 133.204 206.006 117.43 206.006 111.936C206.006 100.487 215.963 93.894 215.963 93.894C215.963 93.894 227.327 86.7998 242.075 86.7998C256.836 86.7998 332.245 90.6251 342.634 104.814C353.022 119.002 352.465 135.388 354.109 148.492C355.752 161.595 349.193 193.797 336.618 199.807L336.632 199.821Z"
      fill="${couleurMonture}"
      stroke="#1D1D1B"
      stroke-width="0.5"
      stroke-miterlimit="10"></path>
  </g>
  <defs>
    <clipPath id="clip0_97_378">
      <rect width="564" height="217" fill="white"></rect>
    </clipPath>

    <!-- Définitions des dégradés pour les verres teintés -->
    <linearGradient
      id="gradient-magenta-rose"
      x1="0%"
      y1="0%"
      x2="100%"
      y2="100%"
    >
      <stop offset="0%" style="stop-color:#FF1493;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#FF69B4;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient
      id="gradient-beige-orange"
      x1="0%"
      y1="0%"
      x2="100%"
      y2="100%"
    >
      <stop offset="0%" style="stop-color:#FFD7BE;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#D2691E;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient id="gradient-cyan-vert" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00CED1;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#32CD32;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient id="gradient-beige-tan" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F5DEB3;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#8B4513;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient
      id="gradient-turquoise-vert"
      x1="0%"
      y1="0%"
      x2="100%"
      y2="100%"
    >
      <stop offset="0%" style="stop-color:#40E0D0;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#228B22;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient
      id="gradient-magenta-fuchsia"
      x1="0%"
      y1="0%"
      x2="100%"
      y2="100%"
    >
      <stop offset="0%" style="stop-color:#FF69B4;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#8B008B;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient
      id="gradient-citron-vert"
      x1="0%"
      y1="0%"
      x2="100%"
      y2="100%"
    >
      <stop offset="0%" style="stop-color:#FFFF00;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#00AA00;stop-opacity:0.8"></stop>
    </linearGradient>
    <linearGradient
      id="gradient-tomate-cramoisi"
      x1="0%"
      y1="0%"
      x2="100%"
      y2="100%"
    >
      <stop offset="0%" style="stop-color:#FF6347;stop-opacity:0.8"></stop>
      <stop offset="100%" style="stop-color:#DC143C;stop-opacity:0.8"></stop>
    </linearGradient>
  </defs>
</svg>`;

    return svg;
  }

  // Permettre de confirmer en appuyant sur Entrée dans l'input
  saveTitleInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      confirmSaveBtn.click();
    }
  });

  // Permettre de fermer en appuyant sur Échap
  document.addEventListener("keydown", (e) => {
    if (
      e.key === "Escape" &&
      saveModal.style.display !== "none" &&
      !saveModal.classList.contains("hidden")
    ) {
      closeSaveModal();
    }
  });
</script>
