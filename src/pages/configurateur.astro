---
import Layout from "../layouts/Layout.astro";
import Materiaux from "../components/Materiaux.astro";
import OptionsVerres from "../components/OptionsVerres.astro";
import CouleursLunettes from "../components/CouleursLunettes.astro";
import Lunettes from "../components/Lunettes.astro";
import ResumConfig from "../components/ResumConfig.astro";
import Tailles from "../components/Tailles.astro";
import Finitions from "../components/Finitions.astro";
import Save from "../components/Save.astro";
import checkIcon from "../assets/check.svg";
import garantIcon from "../assets/garant.svg";
---

<Layout>
  <div class="w-full flex flex-col items-center gap-4 mb-4 bg-white p-8">
    <h1 class="text-3xl font-bold">Personnalisez votre paire</h1>
    <p class="text-gray-600 text-center">
      Choisissez via formulaires ou décrivez en langage naturel. Aperçu en
      direct.
    </p>
    <div class="flex gap-4 justify-center flex-wrap">
      <div class="flex items-center gap-2">
        <img src={checkIcon.src} alt="Check" class="w-5 h-5" />
        <span class="text-sm">Fabrication française</span>
      </div>
      <div class="flex items-center gap-2">
        <img src={garantIcon.src} alt="Garant" class="w-5 h-5" />
        <span class="text-sm">Garantie 2 ans</span>
      </div>
    </div>
  </div>
  <main class="flex flex-col items-center gap-8 mt-16 px-4">
    <div id="main-content" class="w-full flex flex-col items-center gap-8">
      <div class="w-full max-w-4xl mx-auto mb-8">
        <div class="flex items-center justify-between">
          <!-- Step 1 -->
          <div class="flex flex-col items-center">
            <div
              class="w-12 h-12 rounded-full bg-accent text-white flex items-center justify-center font-bold text-lg"
            >
              1
            </div>
            <span class="text-sm font-medium mt-2 text-center"
              >Choix du modèle</span
            >
          </div>

          <!-- Line between Step 1 and 2 -->
          <div
            class="flex-1 h-1 bg-blue-600"
            style="align-self: flex-start; margin-top: 24px;"
          >
          </div>

          <!-- Step 2 -->
          <div class="flex flex-col items-center">
            <div
              class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg"
            >
              2
            </div>
            <span class="text-sm font-medium mt-2 text-center"
              >Configuration</span
            >
          </div>

          <!-- Line between Step 2 and 3 -->
          <div
            class="flex-1 h-1 bg-gray-300"
            style="align-self: flex-start; margin-top: 24px;"
          >
          </div>

          <!-- Step 3 -->
          <div class="flex flex-col items-center">
            <div
              class="w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold text-lg"
            >
              3
            </div>
            <span class="text-sm font-medium mt-2 text-center">Paiement</span>
          </div>
        </div>
      </div>
      <style>
        /* Responsive: stack preview above params on small screens, two columns on desktop (>=1024px) */
        .config-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 2rem;
          width: 100%;
          max-width: 1200px;
          align-items: start;
        }

        @media (min-width: 1024px) {
          .config-grid {
            grid-template-columns: 1fr 1fr;
          }
        }

        /* Keep left column sticky when scrolling */
        .sticky-column {
          position: -webkit-sticky;
          position: sticky;
          top: 10dvh; /* offset from top */
          z-index: 10;
          height: fit-content;
        }

        /* Hide small preview control buttons on mobile/tablet (show on desktop) */
        #vue-avant,
        #vue-profil {
          display: none;
        }

        @media (min-width: 1024px) {
          #vue-avant,
          #vue-profil {
            display: inline-flex;
          }
        }
      </style>

      <div class="config-grid">
        <!-- Colonne gauche: Aperçu + Résumé -->
        <div class="w-full space-y-4 sticky-column">
          <div
            class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
          >
            <div
              class="px-6 py-6 flex justify-between items-center text-gray-800 text-sm font-semibold"
            >
              <span>Aperçu</span>
              <button
                id="fullscreen-btn"
                class="bg-none border-none cursor-pointer p-0 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-gray-400 hover:text-gray-600 transition-colors"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
            </div>

            <div
              class="flex justify-center items-center bg-gray-50 px-6 py-8 mx-4 rounded min-h-80"
            >
              <Lunettes />
            </div>

            <div class="flex justify-center items-center gap-3 px-6 py-6">
              <button
                id="vue-avant"
                class="bg-white text-blue-600 border-[1.5px] border-blue-600 px-3.5 py-1 rounded-full cursor-pointer text-xs font-medium transition-all duration-200"
              >
                Vue Avant
              </button>
              <span
                id="vue-profil"
                class="text-gray-500 text-xs cursor-pointer font-normal"
              >
                Vue Profil
              </span>
            </div>
          </div>

          <ResumConfig />
        </div>

        <!-- Colonne droite: Paramètres -->
        <div class="w-full space-y-4">
          <Materiaux />
          <CouleursLunettes />
          <OptionsVerres />
          <Tailles />
          <Finitions />

          <!-- Bouton Enregistrer -->
          <button
            id="save-btn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 text-sm transition-colors duration-200 rounded cursor-pointer"
          >
            Enregistrer la configuration
          </button>

          <!-- Bouton Réinitialiser -->
          <button
            id="reset-btn"
            class="w-full text-blue-600 hover:text-blue-700 font-medium py-2 px-4 text-sm transition-colors duration-200 underline cursor-pointer"
          >
            Réinitialiser la configuration
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Fullscreen -->
    <div
      id="fullscreen-modal"
      class="hidden fixed inset-0 bg-white/30 backdrop-blur-md z-1000 items-center justify-center"
    >
      <div
        class="bg-white rounded-lg w-[90%] max-w-[900px] max-h-[90vh] overflow-auto shadow-2xl"
      >
        <div
          class="px-6 py-6 flex justify-between items-center text-gray-800 text-sm font-semibold border-b border-gray-200"
        >
          <span>Aperçu Fullscreen</span>
          <button
            id="close-fullscreen-btn"
            class="bg-none border-none cursor-pointer p-0 flex items-center justify-center w-8 h-8"
          >
            <svg
              class="w-6 h-6 text-gray-400 hover:text-gray-600 transition-colors"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div
          class="flex justify-center items-center bg-gray-50 px-8 py-12 min-h-[500px]"
        >
          <Lunettes />
        </div>
      </div>
    </div>

    <!-- Modal Réinitialiser -->
    <div
      id="reset-modal"
      class="fixed bottom-6 right-6 hidden z-1000 opacity-0 translate-y-4 transition-all duration-300"
    >
      <div
        class="bg-white rounded-lg w-[400px] shadow-xl border border-gray-200"
      >
        <div class="px-6 py-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 m-0">
            Réinitialiser la configuration
          </h3>
        </div>

        <div class="px-6 py-6">
          <p class="text-sm text-gray-700 mb-6">
            Êtes-vous sûr de vouloir réinitialiser ? Tous vos paramètres seront
            supprimés et les valeurs par défaut seront restaurées.
          </p>
        </div>

        <div class="px-6 py-4 border-t border-gray-200 flex gap-3 justify-end">
          <button
            id="cancel-reset-btn"
            class="px-4 py-2 border border-gray-300 rounded font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200 cursor-pointer"
          >
            Annuler
          </button>
          <button
            id="confirm-reset-btn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors duration-200 cursor-pointer"
          >
            Réinitialiser
          </button>
        </div>
      </div>
    </div>

    <!-- Save Component -->
    <Save />

    <script is:inline>
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      const fullscreenModal = document.getElementById("fullscreen-modal");
      const closeFullscreenBtn = document.getElementById(
        "close-fullscreen-btn"
      );
      const mainContent = document.getElementById("main-content");

      fullscreenBtn?.addEventListener("click", () => {
        fullscreenModal.classList.remove("hidden");
        fullscreenModal.style.display = "flex";
        mainContent.style.filter = "blur(5px)";
        mainContent.style.pointerEvents = "none";
        document.body.style.overflow = "hidden";
      });

      closeFullscreenBtn?.addEventListener("click", () => {
        fullscreenModal.classList.add("hidden");
        fullscreenModal.style.display = "none";
        mainContent.style.filter = "none";
        mainContent.style.pointerEvents = "auto";
        document.body.style.overflow = "auto";
      });

      fullscreenModal?.addEventListener("click", (e) => {
        if (e.target === fullscreenModal) {
          fullscreenModal.classList.add("hidden");
          fullscreenModal.style.display = "none";
          mainContent.style.filter = "none";
          mainContent.style.pointerEvents = "auto";
          document.body.style.overflow = "auto";
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && fullscreenModal.style.display === "flex") {
          fullscreenModal.classList.add("hidden");
          fullscreenModal.style.display = "none";
          mainContent.style.filter = "none";
          mainContent.style.pointerEvents = "auto";
          document.body.style.overflow = "auto";
        }
      });

      // Bouton Enregistrer
      const saveBtn = document.getElementById("save-btn");
      saveBtn?.addEventListener("click", () => {
        window.openSaveModal?.();
      });

      // Bouton Réinitialiser
      const resetBtn = document.getElementById("reset-btn");
      const resetModal = document.getElementById("reset-modal");
      const cancelResetBtn = document.getElementById("cancel-reset-btn");
      const confirmResetBtn = document.getElementById("confirm-reset-btn");

      resetBtn?.addEventListener("click", () => {
        resetModal.classList.remove("hidden");
        // Forcer un reflow pour que la transition fonctionne
        resetModal.offsetHeight;
        resetModal.classList.remove("opacity-0", "translate-y-4");
        resetModal.classList.add("opacity-100", "translate-y-0");
      });

      cancelResetBtn?.addEventListener("click", () => {
        resetModal.classList.add("opacity-0", "translate-y-4");
        resetModal.classList.remove("opacity-100", "translate-y-0");
        setTimeout(() => {
          resetModal.classList.add("hidden");
        }, 300);
      });

      confirmResetBtn?.addEventListener("click", () => {
        // Effacer tous les éléments du localStorage
        localStorage.removeItem("couleursLunettes");
        localStorage.removeItem("materiaux");
        localStorage.removeItem("optionsVerres");
        localStorage.removeItem("tailles");

        // Recharger la page
        window.location.reload();
      });

      window.addEventListener("changeCouleurLunettes", (e) => {
        const couleur = e.detail.couleur;
        const partie = e.detail.partie;

        if (partie === "monture") {
          const montures = document.querySelectorAll("#monture");
          montures.forEach((monture) => {
            if (monture) {
              monture.style.transition = "fill 0.3s ease";
              monture.setAttribute("fill", couleur);
            }
          });
        } else if (partie === "branches") {
          const branchesAll = document.querySelectorAll("#branches");
          branchesAll.forEach((branch) => {
            branch.style.transition = "fill 0.3s ease";
            branch.setAttribute("fill", couleur);
          });
        }
      });

      // Charger et appliquer les couleurs sauvegardées au chargement
      function loadSavedColors() {
        const couleurs = JSON.parse(
          localStorage.getItem("couleursLunettes") || "{}"
        );
        const optionsVerres = JSON.parse(
          localStorage.getItem("optionsVerres") || "{}"
        );

        // Appliquer la couleur de la monture
        if (couleurs.monture) {
          const montures = document.querySelectorAll("#monture");
          montures.forEach((monture) => {
            if (monture) {
              monture.setAttribute("fill", couleurs.monture);
            }
          });
        }

        // Appliquer la couleur des branches
        if (couleurs.branches) {
          const branches = document.querySelectorAll("#branches");
          branches.forEach((branch) => {
            if (branch) {
              branch.setAttribute("fill", couleurs.branches);
            }
          });
        }

        // Appliquer le gradient des verres
        if (optionsVerres.verresTeintes && optionsVerres.teinte) {
          const colorToGradientMap = {
            "#FF1493": "url(#gradient-magenta-rose)",
            "#FFD7BE": "url(#gradient-beige-orange)",
            "#00CED1": "url(#gradient-cyan-vert)",
            "#F5DEB3": "url(#gradient-beige-tan)",
            "#40E0D0": "url(#gradient-turquoise-vert)",
            "#FFFF00": "url(#gradient-citron-vert)",
            "#FF6347": "url(#gradient-tomate-cramoisi)",
          };

          const gradientUrl = colorToGradientMap[optionsVerres.teinte];
          if (gradientUrl) {
            const verres = document.querySelectorAll("#verres");
            verres.forEach((verre) => {
              if (verre) {
                verre.setAttribute("fill", gradientUrl);
              }
            });
          }
        }
      }

      // Charger les couleurs immédiatement
      loadSavedColors();

      // Aussi au chargement complet de la page
      window.addEventListener("load", loadSavedColors);

      // Et lors du DOMContentLoaded pour plus de réactivité
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadSavedColors);
      }
    </script>
  </main>
</Layout>
