---
import Layout from "../layouts/Layout.astro";

// Ce fichier traite le callback OAuth de PocketBase
---

<Layout title="Connexion via OAuth - TaVue">
  <div class="min-h-screen flex items-center justify-center bg-base-100">
    <div class="text-center">
      <div class="loading loading-spinner loading-lg text-primary"></div>
      <p class="mt-4 text-base-content/60">Redirection en cours...</p>
    </div>
  </div>
</Layout>

<script>
  import pb from "../lib/pocketbase.js";

  // Get URL parameters from OAuth callback
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");
  const state = urlParams.get("state");

  if (code && state) {
    // Exchange the authorization code for a token
    fetch("/apis/oauth-callback", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        code,
        state,
        remember: localStorage.getItem("rememberEmail") ? true : false,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.user) {
          // Redirection logic (same as login form)
          let redirectUrl = "/configurateur";

          if (document.referrer) {
            try {
              const referrerUrl = new URL(document.referrer);
              if (referrerUrl.origin === window.location.origin) {
                if (
                  !referrerUrl.pathname.includes("/login") &&
                  !referrerUrl.pathname.includes("/signup")
                ) {
                  redirectUrl = document.referrer;
                } else {
                  redirectUrl = "/";
                }
              }
            } catch (e) {
              redirectUrl = "/";
            }
          }

          window.location.href = redirectUrl;
        } else {
          // Redirect to login with error
          window.location.href =
            "/login?error=oauth_failed&message=" +
            encodeURIComponent(data.error || "OAuth authentication failed");
        }
      })
      .catch((error) => {
        console.error("OAuth callback error:", error);
        window.location.href =
          "/login?error=oauth_error&message=" +
          encodeURIComponent("An error occurred during OAuth authentication");
      });
  } else {
    // Missing parameters, redirect to login
    window.location.href = "/login?error=missing_params";
  }
</script>
